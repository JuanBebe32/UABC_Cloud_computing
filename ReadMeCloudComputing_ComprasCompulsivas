MANUAL TÉCNICO: Sistema de Análisis de Encuestas con IA
Proyecto: Analizador de Encuestas Automatizado Plataforma: Cloudflare Workers + Supabase + OpenAI Fecha: Noviembre 2025

1. Descripción General
Este sistema automatiza el análisis de encuestas de Google Forms. Funciona mediante un script alojado en la nube (Cloudflare Worker) que se ejecuta automáticamente cada 5 minutos.

Flujo de trabajo:

El sistema consulta la base de datos (Supabase) buscando encuestas nuevas.

Extrae los datos demográficos y respuestas.

Envía la información a la API de OpenAI (GPT-4o-mini) para generar un perfil psicológico.

Guarda el análisis resultante en una tabla separada.

Marca la encuesta original como "procesada" para no repetirla.

2. Requisitos del Sistema
Cloudflare Account: Para alojar el Worker y los Cron Triggers.

Supabase Account: Para la base de datos PostgreSQL.

OpenAI API Key: Para el procesamiento de lenguaje natural.

Entorno Local: Node.js instalado y wrangler CLI configurado.

3. Estructura de la Base de Datos (Supabase)
Se deben ejecutar los siguientes comandos SQL en el SQL Editor de Supabase para preparar las tablas.

A. Tabla de Respuestas (respuestas_googleforms)
Esta tabla almacena los datos crudos de la encuesta. Es fundamental la columna procesado.

SQL

CREATE TABLE public.respuestas_googleforms (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now(),
  carrera TEXT,
  semestre TEXT,
  edad TEXT,
  genero TEXT,
  trabajas TEXT,
  closet TEXT,
  conocidos TEXT,
  vida_compra TEXT,
  innecesario TEXT,
  no_planeado TEXT,
  compulsivo TEXT,
  ofertas TEXT,
  ingresos TEXT,
  deudas TEXT,
  tarjeta TEXT,
  procesado BOOLEAN DEFAULT false
);
B. Tabla de Análisis (analisis_ia)
Esta tabla almacena los resultados generados por la IA.

SQL

CREATE TABLE public.analisis_ia (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now(),
  encuesta_id UUID,
  analisis TEXT
);
C. Inicialización de Datos (Mantenimiento)
Si las encuestas se cargaron antes de crear la columna procesado, ejecutar:

SQL

UPDATE public.respuestas_googleforms
SET procesado = false
WHERE procesado IS NULL;
4. Configuración del Proyecto (Archivos Locales)
A. Archivo tsconfig.json
Configuración simplificada para evitar conflictos de tipos con TypeScript.

JSON

{
  "compilerOptions": {
    "target": "esnext",
    "module": "esnext",
    "lib": ["esnext"],
    "strict": true,
    "moduleResolution": "node",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["index.ts"],
  "exclude": ["node_modules"]
}
B. Archivo wrangler.json
Configuración de despliegue y automatización (Cron Trigger).

JSON

{
  "name": "analizador-ia",
  "main": "index.ts",
  "compatibility_date": "2024-11-14",
  "triggers": {
    "crons": ["*/5 * * * *"]
  },
  "vars": {
    "SUPABASE_URL": "TU_URL_SUPABASE",
    "SUPABASE_SERVICE_KEY": "TU_KEY_SUPABASE",
    "OPENAI_API_KEY": "TU_KEY_OPENAI"
  }
}
(Nota: Reemplazar los valores de vars con las credenciales reales antes del despliegue).

5. Código Fuente Principal (index.ts)
Este código incluye la directiva @ts-nocheck para evitar errores de compilación visuales y utiliza async scheduled para la ejecución automática.

TypeScript

// @ts-nocheck
import { createClient } from "@supabase/supabase-js";
import OpenAI from "openai";

interface Env {
  SUPABASE_URL: string;
  SUPABASE_SERVICE_KEY: string;
  OPENAI_API_KEY: string;
}

export default {
  async scheduled(controller: any, env: Env, ctx: any): Promise<void> {
    console.log("Iniciando tarea programada...");

    const supabase = createClient(env.SUPABASE_URL, env.SUPABASE_SERVICE_KEY);
    const openai = new OpenAI({ apiKey: env.OPENAI_API_KEY });

    // 1. Leer encuesta pendiente
    const { data: pendientes, error: selectError } = await supabase
      .from("respuestas_googleforms")
      .select("*")
      .eq("procesado", false)
      .limit(1);

    if (selectError || !pendientes || pendientes.length === 0) {
      console.log("No hay encuestas pendientes o hubo un error.");
      return;
    }

    const encuesta = pendientes[0];
    console.log(`Procesando encuesta ID: ${encuesta.id}`);

    // 2. Prompt para OpenAI
    const prompt = `
      Analiza esta encuesta de compras compulsivas.
      Datos: Edad: ${encuesta.edad}, Género: ${encuesta.genero}, Trabaja: ${encuesta.trabajas}.
      Respuestas clave:
      - Closet lleno: ${encuesta.closet}
      - Compras compulsivas: ${encuesta.compulsivo}
      - Deudas: ${encuesta.deudas}
      Genera un perfil psicológico profesional.
    `;

    // 3. Llamada a la IA
    let analisis = "Error";
    try {
      const completion = await openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [{ role: "user", content: prompt }]
      });
      analisis = completion.choices[0].message.content ?? "Sin respuesta";
    } catch (err) {
      console.error("Error OpenAI:", err);
      return;
    }

    // 4. Guardar resultado
    await supabase.from("analisis_ia").insert({
      encuesta_id: encuesta.id,
      analisis: analisis,
    });

    // 5. Actualizar estado
    await supabase
      .from("respuestas_googleforms")
      .update({ procesado: true })
      .eq("id", encuesta.id);

    console.log("Finalizado con éxito.");
  }
};
6. Instrucciones de Despliegue y Verificación
Despliegue (Deploy)
Para subir los cambios a producción, ejecutar en la terminal dentro de la carpeta del proyecto:

Bash

wrangler deploy
Verificación de Funcionamiento
Acceder al panel de Cloudflare > Workers & Pages > analizador-ia.

Ir a la pestaña Observability (o Logs).

Asegurarse de que el registro de logs esté en Enabled.

Esperar al ciclo de 5 minutos y observar los mensajes de éxito: Iniciando tarea programada....

Solución de Problemas Comunes
Error: "Handler does not export a scheduled function": Significa que se desplegó una versión antigua del código. Asegurarse de guardar index.ts y ejecutar wrangler deploy nuevamente.

No se procesan datos: Verificar en Supabase que la columna procesado tenga valor false y no NULL.
